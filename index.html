<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­½å¯Œåœ‹éš›å ±åƒ¹å–® (V2.7 æœ€çµ‚ä¿®å¾©ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #1e293b; --internal: #fff7ed; --internal-border: #fdba74; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .container { max-width: 1350px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        /* æ¨™é¡Œèˆ‡é€£ç·šç‹€æ…‹ */
        h2 { border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; color: var(--primary); display: flex; justify-content: space-between; align-items: center; min-height: 40px; }
        .sync-badge { font-size: 12px; background: #eee; padding: 4px 10px; border-radius: 20px; color: #666; display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
        .dot.ok { background: #10b981; box-shadow: 0 0 5px #10b981; }
        .dot.err { background: #ef4444; }
        .dot.loading { background: #eab308; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* è¡¨å–®æ¨£å¼ */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-size: 12px; font-weight: bold; color: #64748b; margin-bottom: 5px; }
        input, select, textarea { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; width: 100%; box-sizing: border-box; }
        
        /* è¯çµ¡äººæ¨™ç±¤æ¨£å¼ */
        .contact-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 5px; min-height: 25px; }
        .c-tag { background: #dbeafe; color: #1e40af; padding: 2px 10px; border-radius: 15px; font-size: 13px; display: flex; align-items: center; gap: 8px; border: 1px solid #bfdbfe; }
        .c-tag span { cursor: pointer; font-weight: bold; color: #ef4444; font-size: 14px; }
        .c-tag span:hover { color: #b91c1c; }

        /* æŒ‰éˆ• */
        .btn { padding: 8px 15px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 13px; margin-right: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-purple { background: #8b5cf6; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-outline { background: white; border: 1px solid #cbd5e1; color: #475569; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-sm { padding: 4px 8px; font-size: 12px; }

        /* åˆ—è¡¨èˆ‡ç¯©é¸ */
        .filter-bar { background: #e0f2fe; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; border: 1px solid #bae6fd; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th { text-align: left; background: #e2e8f0; padding: 10px; cursor: pointer; user-select: none; }
        th:hover { background: #cbd5e1; }
        td { border-bottom: 1px solid #e2e8f0; padding: 10px; }
        tr:hover { background: #f8fafc; }
        .sort-icon { font-size: 10px; margin-left: 5px; color: #666; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; color: white; font-weight: bold; }
        .bg-green { background: #10b981; }
        .bg-gray { background: #94a3b8; }

        /* å ±åƒ¹æ˜ç´° (ä¿®æ”¹æ¬„ä½å¯¬åº¦ä»¥å®¹ç´æˆæœ¬åˆ©æ½¤) */
        .item-grid-layout { 
            display: grid; 
            /* èª¿æ•´æ¬„ä½ï¼šå“å, è¦æ ¼, é•·, å¯¬, å–®ä½, æ‰, é‡, [æˆæœ¬], [åˆ©æ½¤], å–®åƒ¹, é‡‘é¡, åˆªé™¤ */
            grid-template-columns: 2fr 1fr 0.5fr 0.5fr 0.5fr 0.4fr 0.5fr 0.7fr 0.7fr 0.7fr 0.7fr 0.3fr; 
            gap: 5px; align-items: center; 
        }
        .item-header { 
            background: #64748b; color: white; padding: 8px 5px; 
            border-radius: 6px 6px 0 0; font-size: 13px; font-weight: bold; text-align: center;
            margin-bottom: 5px;
        }
        .item-header div { text-align: center; }
        .item-header div:nth-child(1), .item-header div:nth-child(2) { text-align: left; padding-left: 5px; }
        .item-row { margin-bottom: 5px; }
        
        /* å…§éƒ¨æˆæœ¬æ¬„ä½æ¨£å¼ */
        .internal-col { background-color: var(--internal) !important; border-color: var(--internal-border) !important; color: #c2410c; }
        .profit-col { background-color: var(--internal) !important; border-color: var(--internal-border) !important; color: #15803d; font-weight: bold; }

        .total-section { text-align: right; font-size: 18px; font-weight: bold; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #cbd5e1; }
        .internal-total { font-size: 14px; color: #c2410c; margin-right: 15px; background: #fff7ed; padding: 5px 10px; border-radius: 4px; border: 1px solid #fdba74; }

        /* é è¦½èˆ‡åˆ—å° */
        #previewOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 9998; }
        #previewModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; background: white; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border-radius: 8px; max-height: 90vh; overflow-y: auto; padding: 20px; border: 1px solid #ccc; }

        /* A4 åˆ—å°æ¨£å¼ */
        #printArea { display: none; width: 210mm; min-height: 297mm; padding: 15mm; background: white; color: black; box-sizing: border-box; font-family: "Microsoft JhengHei", sans-serif; position: relative; }
        .print-header { text-align: center; margin-bottom: 20px; border-bottom: 3px double #000; padding-bottom: 15px; }
        .company-title { font-size: 26px; font-weight: bold; letter-spacing: 3px; margin-bottom: 5px; }
        .company-info { font-size: 13px; line-height: 1.5; }
        .quote-info-grid { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 14px; }
        .info-row { margin-bottom: 5px; display: flex; }
        .info-label { font-weight: bold; width: 80px; }
        .print-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 20px; }
        .print-table th { background: #f0f0f0; border: 1px solid #000; padding: 6px; text-align: center; }
        .print-table td { border: 1px solid #000; padding: 6px; }
        
        .signature-section { display: flex; justify-content: space-between; margin-top: 40px; }
        .sign-box { 
            width: 45%; border-bottom: 1px solid #000; padding-bottom: 10px; 
            position: relative; min-height: 120px; 
            display: flex; flex-direction: column; justify-content: flex-start;
            cursor: pointer; transition: background 0.2s;
        }
        .sign-box:hover { background: rgba(0,0,0,0.02); }
        .sign-title { font-weight: bold; font-size: 15px; margin-bottom: 5px; z-index: 20; position: relative; }
        .sign-placeholder { color: #ccc; text-align: center; margin-top: auto; margin-bottom: 10px; pointer-events: none; }
        
        .stamp-img { 
            position: absolute; top: 55%; left: 50%;
            transform: translate(-50%, -50%) rotate(-3deg); 
            width: 140px; opacity: 0.95; z-index: 10;
            mix-blend-mode: multiply;
        }
        .stamp-alt-text { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; color: #999; text-align: center; border: 1px dashed #ccc; padding: 5px; width: 80%; }

        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { display: block !important; position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; border: none; }
            .no-print { display: none !important; }
            .sign-box:hover { background: none; }
            .stamp-alt-text { display: none !important; }
        }

        /* ææ–™è³‡æ–™åº«è¦–çª— */
        .mat-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10002; justify-content:center; align-items:center; }
        .mat-content { background:white; width:900px; max-width:95%; height:85vh; padding:20px; border-radius:8px; display:flex; flex-direction:column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .mat-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px; }
        .mat-form-row { display:grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr 80px; gap:10px; align-items:end; background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #e2e8f0; }
        .mat-table-container { flex:1; overflow-y:auto; border:1px solid #eee; border-radius:4px; }
        .mat-table { width:100%; border-collapse:collapse; font-size:13px; }
        .mat-table th { position:sticky; top:0; background:#e2e8f0; padding:8px; text-align:left; font-weight:bold; color:#475569; }
        .mat-table td { padding:8px; border-bottom:1px solid #eee; }
        .mat-table tr:hover { background:#f1f5f9; }
        .profit-high { color: #16a34a; font-weight:bold; } 
        .profit-low { color: #dc2626; font-weight:bold; } 

        /* AI & Modal */
        .price-analysis-card { position: absolute; z-index: 9999; width: 350px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); border: 1px solid #e2e8f0; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }        
        .ai-wrapper { position: relative; display: flex; align-items: center; width: 100%; }
        .btn-ai-analyze { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: #8b5cf6; z-index: 100; padding: 2px; transition: transform 0.2s; }
        .btn-ai-analyze:hover { transform: translateY(-50%) scale(1.2); }
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center; }
        .modal-content-sm { background: white; padding: 20px; border-radius: 8px; width: 400px; max-width:90%; }
    </style>
</head>
<body>

<div id="previewOverlay" onclick="closePreview()"></div>
<div id="previewModal"></div>
<div id="printArea"></div>

<div id="configModal" class="modal">
    <div class="modal-content-sm">
        <h3 style="margin-top:0;">âš™ï¸ é›²ç«¯é€£ç·šè¨­å®š</h3>
        <p style="font-size:12px; color:#666;">è«‹è¼¸å…¥ Google Apps Script éƒ¨ç½²ç¶²å€ (Exec URL)</p>
        <input type="text" id="apiUrlInput" placeholder="https://script.google.com/..." style="width:100%; margin-bottom:15px;">
        <div style="text-align:right;">
            <button class="btn btn-outline" onclick="document.getElementById('configModal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveConfig()">é€£ç·š</button>
        </div>
    </div>
</div>

<input type="file" id="stampLoader" hidden accept="image/*" onchange="loadStampManual(this)">

<div class="container no-print">
    <h2>
        <span>è­½å¯Œåœ‹éš› (V2.7)</span>
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="sync-badge" onclick="openConfigModal()" style="cursor:pointer;" title="é»æ“Šè¨­å®šé€£ç·š">
                <div id="cloudDot" class="dot loading"></div>
                <span id="cloudText">å•Ÿå‹•ä¸­...</span>
            </div>
            <button class="btn btn-outline" onclick="exportData()">ğŸ“¥ å‚™ä»½JSON</button>
            <button class="btn btn-purple" onclick="openMatModal()">ğŸ› ï¸ ææ–™/å•†å“åº«</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            <button class="btn btn-outline" onclick="document.getElementById('importFile').click()">ğŸ“¤ é‚„åŸJSON</button>
            <button class="btn btn-outline" onclick="syncCloudData()">ğŸ”„ å¼·åˆ¶æ•´ç†</button>
        </div>
    </h2>

    <details>
        <summary style="cursor:pointer; font-weight:bold; color:var(--primary); margin-bottom:15px; padding:10px; background:#f0f9ff; border-radius:6px;">â• æ–°å¢/ç·¨è¼¯ å ±åƒ¹å–® (é»æ“Šå±•é–‹)</summary>
        <form id="quoteForm" onsubmit="event.preventDefault(); saveQuote();" style="border:1px solid #e2e8f0; padding:20px; border-radius:8px;">
            <input type="hidden" id="q_id">
            
            <div class="form-grid">
                <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="q_date" required></div>
                <div class="form-group"><label>æœ‰æ•ˆæœŸé™</label><input type="date" id="q_valid"></div>
                <div class="form-group"><label>å°ˆæ¡ˆåç¨±</label><input type="text" id="q_proj" required placeholder="ä¾‹å¦‚ï¼šæ‹›ç‰Œè£½ä½œ"></div>
                
                <div class="form-group">
                    <label>å®¢æˆ¶åç¨± (æœå°‹/åŒæ­¥)</label>
                    <input type="text" id="q_cust" list="cloudCustList" placeholder="è¼¸å…¥è‡ªå‹•å¸¶å‡ºåœ°å€èˆ‡è¯çµ¡äºº..." onchange="autoFillCust(this.value)" required>
                </div>
                
                <div class="form-group" style="grid-column: span 2;">
                    <label>è¯çµ¡äºº (äººå+é›»è©± å¤šé¸)</label>
                    <div id="contactTags" class="contact-tags"></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 40px; gap:5px;">
                        <input type="text" id="q_contact_name" list="custContactList" placeholder="è¯çµ¡äºº (é¸å–å¾Œè‡ªå‹•å¸¶å…¥é›»è©±)" oninput="autoFillContactPhone(this.value)">
                        <input type="text" id="q_contact_phone" placeholder="é›»è©± (å¯æ‰‹å‹•ä¿®æ”¹)">
                        <button type="button" class="btn btn-success btn-sm" onclick="addContactTag()">+</button>
                    </div>
                </div>

                <div class="form-group"><label>å…¬å¸é›»è©±</label><input type="text" id="q_phone" placeholder="å…¬å¸ç¸½æ©Ÿ"></div>
                <div class="form-group"><label>çµ±ç·¨</label><input type="text" id="q_tax_id"></div>
                <div class="form-group" style="grid-column: span 2;"><label>åœ°å€ (å¯å›å­˜)</label><input type="text" id="q_address" placeholder="å®¢æˆ¶åœ°å€"></div>
            </div>

            <div style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid #e2e8f0; margin-bottom:15px;">
                <label style="color:var(--primary); margin-bottom:10px; display:block;">å ±åƒ¹æ˜ç´°</label>
                <div class="item-grid-layout item-header">
                    <div>é …ç›®</div><div>è¦æ ¼</div><div>é•·(cm)</div><div>å¯¬(cm)</div><div>å–®ä½</div>
                    <div>æ‰æ•¸</div><div>æ•¸é‡</div>
                    <div style="color:#fdba74;">æˆæœ¬(å–®)</div>
                    <div style="color:#22c55e;">æ¯›åˆ©</div>
                    <div>å–®åƒ¹</div><div>é‡‘é¡</div><div></div>
                </div>
                <div id="itemContainer"></div>
                <button type="button" class="btn btn-success btn-sm" style="margin-top:10px;" onclick="addItem()">+ å¢åŠ é …ç›®</button>
                
                <div class="total-section">
                    <span class="internal-total">é ä¼°ç¸½æ¯›åˆ©: <span id="display_profit">$0</span></span>
                    æœªç¨…: <span id="display_sub">$0</span> | 
                    ç¨…é‡‘(<input type="number" id="q_tax_rate" value="5" style="width:45px; padding:2px; text-align:center; border:1px solid #ccc; border-radius:4px; font-weight:bold;" oninput="calcTotal()">%): 
                    <span id="display_tax">$0</span> | 
                    ç¸½è¨ˆ: <span id="display_total">$0</span>
                </div>
            </div>

            <div class="form-group"><label>å‚™è¨»æ¢æ¬¾</label><textarea id="q_note" rows="15"></textarea></div>

            <div style="margin-top:20px;">
                <button class="btn btn-primary">ğŸ’¾ å„²å­˜ (åŒæ­¥è‡³é›²ç«¯)</button>
                <button type="button" class="btn btn-outline" onclick="resetForm()">ğŸ”„ æ¸…ç©º</button>
            </div>
        </form>
    </details>

    <hr style="margin: 25px 0;">

    <div class="filter-bar">
        <div class="form-group"><label>æ—¥æœŸèµ·</label><input type="date" id="filter_start" onchange="renderList()"></div>
        <div class="form-group"><label>æ—¥æœŸè¿„</label><input type="date" id="filter_end" onchange="renderList()"></div>
        <div class="form-group"><label>ç‹€æ…‹</label>
            <select id="filter_status" onchange="renderList()">
                <option value="all">å…¨éƒ¨</option>
                <option value="converted">âœ… å·²è½‰è¨‚å–®</option>
                <option value="unconverted">â¬œ æœªè½‰è¨‚å–®</option>
            </select>
        </div>
        <div class="form-group" style="flex:1;">
            <label>æœå°‹</label><input type="text" id="searchInput" placeholder="æœå°‹å°ˆæ¡ˆã€å®¢æˆ¶..." oninput="renderList()">
        </div>
    </div>

    <table id="listTable">
        <thead>
            <tr>
                <th onclick="sortList('id')" style="width:90px;">å–®è™Ÿ(é è¦½) <span id="sort_id" class="sort-icon">â–¼</span></th>
                <th onclick="sortList('date')">æ—¥æœŸ <span id="sort_date" class="sort-icon"></span></th>
                <th onclick="sortList('cust')">å®¢æˆ¶ <span id="sort_cust" class="sort-icon"></span></th>
                <th onclick="sortList('proj')">å°ˆæ¡ˆ <span id="sort_proj" class="sort-icon"></span></th>
                <th onclick="sortList('total')">ç¸½é¡ <span id="sort_total" class="sort-icon"></span></th>
                <th onclick="sortList('converted')">ç‹€æ…‹ <span id="sort_converted" class="sort-icon"></span></th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="quoteListBody"></tbody>
    </table>
</div>

<div id="matModal" class="mat-modal">
    <div class="mat-content">
        <div class="mat-header">
            <h3 style="margin:0; color:#4338ca;">ğŸ› ï¸ é …ç›®èˆ‡ææ–™è³‡æ–™åº« (æ¨™æº–å ±åƒ¹)</h3>
            <button class="btn btn-danger btn-sm" onclick="closeMatModal()">âœ• é—œé–‰</button>
        </div>

        <div class="mat-form-row">
            <input type="hidden" id="m_id">
            <div class="form-group">
                <label>é …ç›®åç¨±</label>
                <input type="text" id="m_name" placeholder="ä¾‹å¦‚: 5mmå£“å…‹åŠ›">
            </div>
            <div class="form-group">
                <label>å–®ä½</label>
                <input type="text" id="m_unit" list="unitList" placeholder="å¼/æ‰/çµ„">
            </div>
            <div class="form-group">
                <label>æ¨™æº–å–®åƒ¹ ($)</label>
                <input type="number" id="m_price" placeholder="å ±åƒ¹">
            </div>
            <div class="form-group">
                <label>é ä¼°æˆæœ¬ ($)</label>
                <input type="number" id="m_cost" placeholder="åº•åƒ¹">
            </div>
            <div class="form-group">
                <label>é è¦½æ¯›åˆ©</label>
                <input type="text" id="m_profit" disabled style="background:#f1f5f9; border:none; font-weight:bold;" placeholder="%">
            </div>
            <button class="btn btn-success" onclick="saveMaterial()">ğŸ’¾ å„²å­˜</button>
        </div>

        <div style="margin-bottom:10px; display:flex; gap:10px;">
            <input type="text" id="m_search" placeholder="ğŸ” æœå°‹é …ç›®..." oninput="renderMatTable()" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px;">
        </div>

        <div class="mat-table-container">
            <table class="mat-table">
                <thead>
                    <tr>
                        <th width="35%">é …ç›®åç¨±</th>
                        <th width="10%">å–®ä½</th>
                        <th width="15%">æ¨™æº–å–®åƒ¹</th>
                        <th width="15%">æˆæœ¬</th>
                        <th width="10%">æ¯›åˆ©ç‡</th>
                        <th width="15%">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="matListBody"></tbody>
            </table>
        </div>
    </div>
</div>

<datalist id="cloudCustList"></datalist>
<datalist id="custContactList"></datalist> 
<datalist id="prodList"></datalist>
<datalist id="unitList"><option value="å¼"><option value="çµ„"><option value="ä»¶"><option value="å€‹"><option value="æ‰"><option value="æ¨˜"><option value="æ”¯"><option value="å°"><option value="å…¬åˆ†"></datalist>

<script>
    let API_URL = '';
    const DEFAULT_PRODUCTS = ["PPäº®","PPéœ§","PVCéœ§","PVCäº®","å…¨é€äº®","å…¨é€éœ§","åŠé€äº®","åŠé€éœ§","é›™é€å¸ƒ","å–®é€å¸ƒ","æ²¹ç•«å¸ƒ","æ–œç´‹å¸ƒ","åˆæˆæ¿","å¼·å…‰æ¿","ç™¼æ³¡æ¿","ä¸­ç©ºæ¿","ç„¡æ¥ç¸«","å£“å…‹åŠ›","ç«‹é«”ç™¼å…‰å­—","éœ“è™¹ç‡ˆå­—","æ‹›ç‰Œç‡ˆç®±","å£“å…‹åŠ›ç‡ˆç®±"];
    const DEFAULT_NOTE = `ä»¥ä¸Šå ±åƒ¹ç‚ºä¸å«ç¾ç·¨ (è«‹è‡ªå‚™å®Œæ•´å¯å°åˆ·ç¾å·¥é›»å­æª”)ã€æª”æ¡ˆè«‹è‡ªè¡Œåšå¥½å†ç™¼å°ï¼Œæ•æœ¬å…¬å¸ç„¡æ³•å”åŠ©ä¿®æ”¹ã€‘
â˜…æœ¬å ±åƒ¹å–®ç¶“é›™æ–¹ç¢ºèªç°½ç« å¾Œ,å³å¯è¦–ç‚ºæ­£å¼è¨‚å–®.å…·æœ‰æ³•å¾‹æ•ˆåŠ›ï¼Œæœ¬å…¬å¸å ±åƒ¹äººå“¡å¦‚æœ‰å ±åƒ¹éŒ¯èª¤ï¼Œæœ¬å…¬å¸å¾—ä»¥ä¿ç•™æ¥å–®èˆ‡å¦ä¹‹æ¬Šåˆ©ã€‚
â˜…ä¸‹å–®å‰. è«‹è©³é–±æœ¬å…¬å¸å®˜ç¶²çš„"æ³¨æ„äº‹é …"
è¼¸å‡ºæ³¨æ„äº‹é …å¯é€£çµ http://www.yufudesign.com.tw/?urlid=webpage&sn=12
â˜…åˆç‰ˆå°åˆ·. æ¯æ¬¡é€²ç´™. åšåº¦å¤šå°‘æœ‰äº›èª¤å·®..è‹¥ç„¡æ³•æ¥å— å¦å¤–ä¼°åƒ¹
â˜…å¤§åœ–è¼¸å‡ºæ™‚, æœ¬å…¬å¸å°ºå¯¸åƒ…å¤š1cmé ç•™èª¤å·®, è‹¥ç¾å ´æ–½å·¥ç™¼ç¾å°ºå¯¸ä¸è¶³, è²»ç”¨éœ€è‡ªè¡Œè² æ“”ã€‚
â˜…æ–½å·¥ç¾å ´é©—æ”¶æ™‚,è«‹ç”±æ¬Šè²¬ä¸»ç®¡æˆ–å§”ä»»è¨­è¨ˆå¸«,å…¶ä¸€æ–¹åˆ°å ´é©—æ”¶,å¦‚ç•¶å¤©æœªèƒ½é©—æ”¶å®Œç•¢,
é ˆå¦å¤–é…Œæ”¶è»Šé¦¬è²»$1700å…ƒæ•´ã€‚
â˜…æª”æ¡ˆå¦‚éæ–¹å½¢ï¼Œéœ€è¦é¡å¤–å‰²å‹ï¼Œè«‹æ–¼æª”æ¡ˆå…§ç•«å¥½å‰²å‹çš„åˆ€æ¨¡æ¡†ç·šï¼Œå¦å‰‡æª”æ¡ˆå°‡ç„¡æ³•å°è£½ã€‚
â˜…æœ¬å ±åƒ¹ç‚º7å¤©å…§æœ‰æ•ˆ(å«ä¾‹å‡æ—¥)
â˜… â˜…ä»˜æ¬¾å¾Œè£½ä½œâ˜… â˜…ï¼ˆåŒ¯æ¬¾ç”¢ç”Ÿä¹‹ä»»ä½•æ‰‹çºŒè²»éœ€ç”±å®¢æˆ¶ç«¯è‡ªè¡Œæ“”ä»˜ï¼‰
è½‰å¸³è³‡æ–™~
ç¬¬ä¸€éŠ€è¡Œ åŸ”å¢˜åˆ†è¡Œ (007)
æˆ¶åï¼šè­½å¯Œåœ‹éš›æœ‰é™å…¬å¸
å¸³è™Ÿï¼š238-100-65601
*å¦‚è’™æƒ é¡§ï¼Œè«‹æ–¼ä¸‹æ–¹ç¢ºèªç°½åè“‹ç« ï¼Œmailæˆ–LINEå›è¦†ï¼Œè¬è¬`;
    
    const COMPANY_INFO = { title: "è­½å¯Œåœ‹éš›æœ‰é™å…¬å¸", details: "çµ±ä¸€ç·¨è™Ÿï¼š54036027 | é›»è©±ï¼š(02) 2959-9137" };

    let db = { quotes: [], products: [...DEFAULT_PRODUCTS], materials: [] }; 
    let cloudDB = {}; 
    let sortState = { field: 'id', dir: 'desc' };
    let stampData = 'æ°‘ç”Ÿå…¬å¸ç™¼ç¥¨ç« 1.png';
    let currentQuoteContacts = []; 

    window.onload = function() {
        const savedUrl = localStorage.getItem('erp_api_url');
        if(savedUrl) { API_URL = savedUrl; syncCloudData(); }
        
        db = { quotes: [], products: [...DEFAULT_PRODUCTS], materials: [] }; 
        document.getElementById('filter_start').value = '';
        document.getElementById('filter_end').value = '';
        updateProdList();
        resetForm();
        try { const savedStamp = localStorage.getItem('erp_stamp_img'); if(savedStamp) stampData = savedStamp; } catch(e) {}
    };

    function openConfigModal() { document.getElementById('apiUrlInput').value = API_URL; document.getElementById('configModal').style.display = 'flex'; }
    function saveConfig() {
        const u = document.getElementById('apiUrlInput').value.trim();
        if(u) { API_URL = u; localStorage.setItem('erp_api_url', u); document.getElementById('configModal').style.display='none'; syncCloudData(); }
    }

    function saveToLocal() { try { localStorage.setItem('erp_quote_v17', JSON.stringify(db)); } catch(e) {} }

    function loadStampManual(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                stampData = e.target.result;
                localStorage.setItem('erp_stamp_img', stampData);
                alert('âœ… å°ç« è¼‰å…¥æˆåŠŸï¼');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function getLastPrice(productName) {
        if (!productName || !db.quotes) return null;
        for (const q of db.quotes) {
            if (q.items && Array.isArray(q.items)) {
                const found = q.items.find(i => i.desc === productName);
                if (found) return found.price;
            }
        }
        return null;
    }

    function autoFillPrice(el) {
        const name = el.value.trim();
        if(!name) return;

        const row = el.closest('.item-row');
        const priceInput = row.querySelector('.i-price');
        const costInput = row.querySelector('.i-cost');
        const unitInput = row.querySelector('.i-unit');

        let dbMat = null;
        if(db.materials) dbMat = db.materials.find(m => m.name === name);
        const historyPrice = getLastPrice(name);

        let finalPrice = null;
        let finalUnit = null;
        let finalCost = null;
        let source = ''; 

        if (dbMat) {
            finalPrice = dbMat.price;
            finalUnit = dbMat.unit;
            finalCost = dbMat.cost; 
            source = 'db'; 
        } else if (historyPrice !== null) {
            finalPrice = historyPrice;
            source = 'hist'; 
        }

        if (finalPrice !== null) {
            if (priceInput.value == '' || parseFloat(priceInput.value) !== parseFloat(finalPrice)) {
                priceInput.value = finalPrice;
                calcRow(priceInput); 
                let color = source === 'db' ? '#dbeafe' : '#dcfce7'; 
                priceInput.style.backgroundColor = color;
                setTimeout(() => priceInput.style.backgroundColor = '', 1000);
            }
        }

        if (finalCost !== null && (costInput.value == '' || costInput.value == '0')) {
            costInput.value = finalCost;
            calcRow(priceInput);
            costInput.style.backgroundColor = '#ffedd5';
            setTimeout(() => costInput.style.backgroundColor = 'var(--internal)', 1000);
        }

        if (finalUnit && (unitInput.value === '' || unitInput.value === 'å¼')) {
            unitInput.value = finalUnit;
            unitInput.style.backgroundColor = '#fef3c7';
            setTimeout(() => unitInput.style.backgroundColor = '', 1000);
        }
    }

    function autoFillCust(name) {
        if(!cloudDB.p) return;
        const c = cloudDB.p.find(x => x.name === name);
        if (c) {
            document.getElementById('q_phone').value = c.phone || '';
            document.getElementById('q_tax_id').value = c.tax || '';
            document.getElementById('q_address').value = c.address || '';
            const list = document.getElementById('custContactList');
            list.innerHTML = '';
            if(c.contacts && Array.isArray(c.contacts)) {
                c.contacts.forEach(ct => { 
                    if(ct.n) { const opt = document.createElement('option'); opt.value = ct.n; list.appendChild(opt); }
                });
            }
        }
    }

    function autoFillContactPhone(name) {
        const custName = document.getElementById('q_cust').value;
        const c = cloudDB.p ? cloudDB.p.find(x => x.name === custName) : null;
        const phoneInput = document.getElementById('q_contact_phone');
        if (c && c.contacts) {
            const target = c.contacts.find(ct => ct.n === name);
            if (target && target.p) phoneInput.value = target.p;
        }
    }

    function addContactTag() {
        const nameInput = document.getElementById('q_contact_name');
        const phoneInput = document.getElementById('q_contact_phone');
        const name = nameInput.value.trim();
        const phone = phoneInput.value.trim();
        if(!name) return;
        if(currentQuoteContacts.some(c => c.n === name && c.p === phone)) { alert('å·²åŠ å…¥'); return; }
        currentQuoteContacts.push({ n: name, p: phone });
        renderContactTags();
        nameInput.value = ''; phoneInput.value = '';
    }

    function removeContactTag(idx) { currentQuoteContacts.splice(idx, 1); renderContactTags(); }
    function renderContactTags() {
        const div = document.getElementById('contactTags');
        div.innerHTML = currentQuoteContacts.map((c, idx) => `<div class="c-tag">${c.n}${c.p ? ' ('+c.p+')' : ''} <span onclick="removeContactTag(${idx})">Ã—</span></div>`).join('');
    }

    async function syncCloudData() {
        const dot = document.getElementById('cloudDot');
        const text = document.getElementById('cloudText');
        dot.className = 'dot loading'; text.innerText = 'ä¸‹è¼‰ä¸­...';
        
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            if(data) {
                cloudDB = data; 
                db.quotes = (cloudDB.q && Array.isArray(cloudDB.q)) ? cloudDB.q : [];
                if(!cloudDB.p) cloudDB.p = [];
                if(!cloudDB.o) cloudDB.o = [];
                
                if(data.materials && Array.isArray(data.materials)) {
                    db.materials = data.materials;
                } else {
                    if(!db.materials) db.materials = [];
                }

                db.quotes.sort((a, b) => b.id - a.id);
                renderList();
                updateCustList();
                updateProdList(); 

                dot.className = 'dot ok'; text.innerText = `åŒæ­¥å®Œæˆ (${db.quotes.length}å–®)`;
                saveToLocal(); 
            }
        } catch(e) { 
            console.error(e); 
            dot.className = 'dot err'; text.innerText = 'é€£ç·šå¤±æ•—'; 
        }
    }

    async function pushToCloud(quoteData) {
        const dot = document.getElementById('cloudDot');
        const text = document.getElementById('cloudText');
        text.innerText = 'ä¸Šå‚³ä¸­...'; dot.className = 'dot loading';
        try {
            const payload = { action: 'save_quote', data: quoteData, custData: cloudDB.p };
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            dot.className = 'dot ok'; text.innerText = 'ä¸Šå‚³æˆåŠŸ';
            await syncCloudData(); 
        } catch(e) { 
            dot.className = 'dot err'; text.innerText = 'ä¸Šå‚³å¤±æ•—'; 
            alert('âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ï¼'); 
        }
    }

    function updateCustList() { if(cloudDB.p) document.getElementById('cloudCustList').innerHTML = cloudDB.p.map(c => `<option value="${c.name}">`).join(''); }
    
    function updateProdList() {
        const allItems = new Set(db.products || []);
        if (db.materials) {
            db.materials.forEach(m => { if(m.name) allItems.add(m.name); });
        }
        const list = document.getElementById('prodList');
        if(list) {
            const sorted = Array.from(allItems).sort();
            list.innerHTML = sorted.map(p => `<option value="${p}">`).join('');
        }
    }

    async function saveQuote() {
        const dot = document.getElementById('cloudDot');
        if(dot.className.includes('loading')) { alert('åŒæ­¥ä¸­...'); return; }

        const id = document.getElementById('q_id').value;
        const custName = document.getElementById('q_cust').value;
        const phone = document.getElementById('q_phone').value;
        const taxId = document.getElementById('q_tax_id').value;
        const address = document.getElementById('q_address').value;
        
        const pendingName = document.getElementById('q_contact_name').value.trim();
        const pendingPhone = document.getElementById('q_contact_phone').value.trim();
        if(pendingName && !currentQuoteContacts.some(c => c.n === pendingName && c.p === pendingPhone)) {
            currentQuoteContacts.push({ n: pendingName, p: pendingPhone });
        }
        
        const contactStr = currentQuoteContacts.map(c => c.n + (c.p ? '('+c.p+')' : '')).join('ã€');

        if(!custName) return alert('è«‹è¼¸å…¥å®¢æˆ¶åç¨±');

        document.querySelectorAll('.i-desc').forEach(input => {
            const val = input.value.trim();
            if(val && !db.products.includes(val)) db.products.push(val);
        });
        updateProdList();

        if(!cloudDB.p) cloudDB.p = [];
        let p = cloudDB.p.find(x => x.name === custName);
        if (!p) {
            const newContacts = currentQuoteContacts.map(c => ({ n: c.n, p: c.p || '', l: '' }));
            cloudDB.p.push({ id: Date.now(), name: custName, type: 'c', phone: phone, tax: taxId, address: address, contact: contactStr, contacts: newContacts });
        } else {
            p.phone = phone; p.tax = taxId; p.address = address; p.contact = contactStr;
            if(!p.contacts) p.contacts = [];
            currentQuoteContacts.forEach(newC => {
                const existing = p.contacts.find(pc => pc.n === newC.n);
                if (existing) { if (newC.p) existing.p = newC.p; } 
                else { p.contacts.push({ n: newC.n, p: newC.p || '', l: '' }); }
            });
        }

        let items=[]; 
        document.querySelectorAll('.item-row').forEach(r=>{ 
            items.push({ 
                desc: r.querySelector('.i-desc').value, 
                spec: r.querySelector('.i-spec').value,
                w: r.querySelector('.i-w').value, h: r.querySelector('.i-h').value, 
                unit: r.querySelector('.i-unit').value, 
                tal: r.querySelector('.i-tal').value, qty: r.querySelector('.i-qty').value, 
                cost: parseFloat(r.querySelector('.i-cost').value)||0, 
                price: r.querySelector('.i-price').value, amt: parseFloat(r.querySelector('.i-amt').value)||0 
            }); 
        });
        
        const {sub, tax, total, taxRate} = calcTotal();
        const q = { 
            id: id?parseInt(id):Date.now(), 
            date: document.getElementById('q_date').value, 
            valid: document.getElementById('q_valid').value, 
            proj: document.getElementById('q_proj').value, 
            cust: custName, phone, taxId, contact: contactStr, address, 
            items, subtotal: sub, tax, total, taxRate, 
            note: document.getElementById('q_note').value,
            converted: false 
        };
        
        if(id) { 
            const idx=db.quotes.findIndex(x=>x.id==id); 
            if(idx!==-1) { q.converted = db.quotes[idx].converted; db.quotes[idx]=q; }
        } else {
            db.quotes.unshift(q);
        }
        
        saveToLocal();
        await pushToCloud(q);
        
        renderList(); 
        resetForm();
        alert('âœ… å„²å­˜æˆåŠŸï¼');
    }

    async function convertToOrder(quoteId) {
        const q = db.quotes.find(x => x.id == quoteId);
        
        if(!q) return alert('æ‰¾ä¸åˆ°æ­¤å ±åƒ¹å–®è³‡æ–™');
        if(q.converted && !confirm('æ­¤å ±åƒ¹å–®å·²è½‰éè¨‚å–®ï¼Œè¦å†æ¬¡è½‰å–®å—ï¼Ÿ')) return;
        if(!confirm(`ç¢ºå®šå°‡å ±åƒ¹å–® #${q.id} è½‰ç‚ºæ­£å¼è¨‚å–®ï¼Ÿ\n(å°‡å¯«å…¥é›²ç«¯ ERP)`)) return;

        const newOrder = {
            id: Date.now(), 
            date: q.date, 
            proj: q.proj, 
            cust: q.cust, 
            taxId: q.taxId || "", 
            contact: q.contact, 
            phone: q.phone, 
            address: q.address,
            invoice: 'ç„¡', invNum: '', 
            price: q.total, base: q.subtotal, tax: q.tax, 
            deposit: 0, pay: 'æœªæ”¶æ¬¾', bank: '', 
            note: `[ç”±å ±åƒ¹å–® #${q.id} è½‰å…¥] ${q.note}`, 
            items: q.items ? q.items.map(i => {
                let finalName = i.desc || '';
                if (i.spec) finalName = finalName ? `${finalName} (${i.spec})` : i.spec;
                return { 
                    name: finalName, 
                    spec: i.spec, 
                    w: i.w, h: i.h, 
                    unit: i.unit, 
                    qty: i.qty, 
                    price: i.price, 
                    cost: i.cost || 0, 
                    amt: i.amt 
                };
            }) : [],
            subs: [] 
        };

        const dot = document.getElementById('cloudDot');
        const text = document.getElementById('cloudText');
        if(text) text.innerText = 'è®€å–é›²ç«¯è¨‚å–®...';
        if(dot) dot.className = 'dot loading';

        try {
            const res = await fetch(API_URL);
            const cloudData = await res.json();
            
            let currentOrders = (cloudData && cloudData.o && Array.isArray(cloudData.o)) ? cloudData.o : [];
            currentOrders.unshift(newOrder);
            
            if(text) text.innerText = 'æ­£åœ¨å¯«å…¥ ERP...';
            
            await fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'save_erp', orders: currentOrders }) 
            });
            
            q.converted = true;
            await pushToCloud(q); 

            alert('âœ… è½‰å–®æˆåŠŸï¼è³‡æ–™å·²å¯«å…¥ ERP ç³»çµ±ã€‚');
            if(dot) dot.className = 'dot ok';
            if(text) text.innerText = 'å®Œæˆ';
            
            renderList();

        } catch(e) {
            console.error(e);
            alert('âŒ è½‰å–®å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚');
            if(dot) dot.className = 'dot err';
            if(text) text.innerText = 'å¤±æ•—';
        }
    }

    function addItem(desc='', spec='', w='', h='', qty=1, price=0, unit='å¼', amt=0, cost=0) {
        const div = document.createElement('div'); 
        div.className = 'item-grid-layout item-row';
        
        div.innerHTML = `
            <div class="ai-wrapper" style="position: relative; display: flex; align-items: center; width: 100%;">
                <input type="text" class="i-desc" list="prodList" value="${desc}" 
                       onchange="autoFillPrice(this)" 
                       style="width:100%; padding-right:35px;" placeholder="è¼¸å…¥å“å...">
                <button type="button" class="btn-ai-analyze" onclick="showPriceAnalysis(this)" title="AI åˆ†æ" style="position: absolute; right: 5px; background: none; border: none; cursor: pointer; font-size: 18px; z-index: 10;">ğŸ§ </button>
            </div>

            <input type="text" class="i-spec" value="${spec}" oninput="parseSpecSize(this)" placeholder="ä¾‹: 120x60">
            
            <input type="number" class="i-w" value="${w}" oninput="calcRow(this)">
            <input type="number" class="i-h" value="${h}" oninput="calcRow(this)">
            <input type="text" class="i-unit" list="unitList" value="${unit}">
            <input type="text" class="i-tal" readonly style="background:#eee; text-align:center;">
            <input type="number" class="i-qty" value="${qty}" oninput="calcRow(this)">
            
            <input type="number" class="i-cost internal-col" value="${cost}" placeholder="æˆæœ¬" oninput="calcRow(this)">
            <input type="text" class="i-profit profit-col" readonly tabindex="-1" placeholder="åˆ©æ½¤">

            <input type="number" class="i-price" value="${price}" oninput="calcRow(this)">
            <input type="number" class="i-amt" value="${amt || 0}" onchange="calcTotal()">
            <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove(); calcTotal()">X</button>
        `;
        document.getElementById('itemContainer').appendChild(div); 
        if(w || h || price || cost) calcRow(div.querySelector('.i-w'), amt > 0);
    }

    function calcRow(el, preserveAmt = false) {
        const row = el.closest('.item-row');
        const w = parseFloat(row.querySelector('.i-w').value)||0, h = parseFloat(row.querySelector('.i-h').value)||0;
        const qty = parseFloat(row.querySelector('.i-qty').value)||0, price = parseFloat(row.querySelector('.i-price').value)||0;
        const cost = parseFloat(row.querySelector('.i-cost').value)||0; 
        
        let tal = 0;
        if(w>0 && h>0) {
            tal = Math.ceil((w*h)/900); if(tal<1) tal=1; 
            row.querySelector('.i-tal').value = tal;
        } else { row.querySelector('.i-tal').value = '-'; }
        
        const multiplier = tal > 0 ? tal : 1;

        if(!preserveAmt) {
            const sub = Math.round(price * multiplier * qty);
            row.querySelector('.i-amt').value = sub;
        }

        const profit = Math.round((price - cost) * multiplier * qty);
        const profitEl = row.querySelector('.i-profit');
        profitEl.value = profit;
        
        if(profit < 0) profitEl.style.color = 'red';
        else profitEl.style.color = '#15803d';

        calcTotal();
    }

    function calcTotal() {
        let sub = 0; 
        let totalProfit = 0;

        document.querySelectorAll('.item-row').forEach(row => {
            sub += (parseFloat(row.querySelector('.i-amt').value)||0);
            totalProfit += (parseFloat(row.querySelector('.i-profit').value)||0);
        });
        
        const rateInput = document.getElementById('q_tax_rate');
        const rate = rateInput ? parseFloat(rateInput.value) : 5;
        const tax = Math.round(sub * (rate / 100));
        
        document.getElementById('display_sub').innerText = '$'+sub.toLocaleString();
        document.getElementById('display_tax').innerText = '$'+tax.toLocaleString();
        document.getElementById('display_total').innerText = '$'+(sub+tax).toLocaleString();
        document.getElementById('display_profit').innerText = '$'+totalProfit.toLocaleString(); 
        
        return { sub, tax, total: sub+tax, taxRate: rate };
    }

    function resetForm() {
        document.getElementById('quoteForm').reset(); document.getElementById('q_id').value=''; 
        document.getElementById('q_date').valueAsDate=new Date(); 
        document.getElementById('q_note').value=DEFAULT_NOTE; 
        document.getElementById('q_tax_rate').value = 5;
        document.getElementById('itemContainer').innerHTML=''; 
        currentQuoteContacts = []; renderContactTags();
        addItem(); calcTotal();
    }

    function renderList() {
        const key = document.getElementById('searchInput').value.toLowerCase();
        const start = document.getElementById('filter_start').value;
        const end = document.getElementById('filter_end').value;
        const status = document.getElementById('filter_status').value;

        let list = db.quotes.filter(q => {
            const inDate = (!start || q.date >= start) && (!end || q.date <= end);
            const inStatus = (status === 'all') || (status === 'converted' && q.converted) || (status === 'unconverted' && !q.converted);
            const inKey = (q.cust + q.proj + (q.id||'')).toLowerCase().includes(key);
            return inDate && inStatus && inKey;
        });

        list.sort((a, b) => {
            let valA = a[sortState.field], valB = b[sortState.field];
            if(sortState.field==='total'||sortState.field==='id') return sortState.dir==='asc'? valA-valB : valB-valA;
            return sortState.dir==='asc'? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
        });

        document.getElementById('quoteListBody').innerHTML = list.map(q => `
            <tr>
                <td style="color:var(--primary); font-weight:bold; cursor:pointer;" onmouseenter="previewQuote(${q.id})" title="é è¦½">#${q.id} ğŸ‘ï¸</td>
                <td>${q.date}</td><td>${q.cust}</td><td>${q.proj}</td>
                <td>$${(q.total||0).toLocaleString()}</td>
                <td><span class="badge ${q.converted?'bg-green':'bg-gray'}">${q.converted?'å·²è½‰è¨‚å–®':'æœªè½‰è¨‚å–®'}</span></td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="copyQuote('${q.id}')" title="è¤‡è£½">ğŸ“‹</button>
                    <button class="btn btn-sm btn-outline" onclick="editQuote('${q.id}')" title="ç·¨è¼¯">âœï¸</button>
                    <button class="btn btn-sm btn-primary" onclick="printQuote('${q.id}', 'pdf')" title="åˆ—å°PDF">ğŸ–¨ï¸</button>
                    <button class="btn btn-sm btn-success" onclick="printQuote('${q.id}', 'jpg')" title="è½‰å­˜JPG">ğŸ–¼ï¸</button>
                    <button class="btn btn-sm btn-purple" onclick="convertToOrder('${q.id}')" title="è½‰è¨‚å–®">â˜ï¸</button>
                    <button class="btn btn-sm btn-danger" onclick="delQuote('${q.id}')" title="åˆªé™¤">ğŸ—‘ï¸</button>
                </td>
            </tr>
        `).join('');
    }

    function editQuote(id) { 
        const q=db.quotes.find(x=>x.id==id); if(!q)return; 
        document.getElementById('q_id').value=q.id; 
        document.getElementById('q_date').value=q.date; 
        document.getElementById('q_valid').value=q.valid||''; 
        document.getElementById('q_proj').value=q.proj; 
        document.getElementById('q_cust').value=q.cust; 
        
        currentQuoteContacts = [];
        if (q.contact) {
            const parts = q.contact.split('ã€');
            parts.forEach(str => {
                const match = str.match(/^(.*?)\((.*?)\)$/);
                if (match) currentQuoteContacts.push({ n: match[1], p: match[2] });
                else currentQuoteContacts.push({ n: str, p: '' });
            });
        }
        renderContactTags();

        document.getElementById('q_phone').value=q.phone||''; 
        document.getElementById('q_address').value=q.address||''; 
        document.getElementById('q_tax_id').value=q.taxId||''; 
        document.getElementById('q_note').value=q.note; 
        document.getElementById('q_tax_rate').value = (q.taxRate !== undefined) ? q.taxRate : 5;

        document.getElementById('itemContainer').innerHTML=''; 
        if(q.items) q.items.forEach(i=>addItem(i.desc,i.spec,i.w,i.h,i.qty,i.price, i.unit, i.amt, i.cost)); 
        calcTotal();
        document.querySelector('details').open = true; window.scrollTo(0,0); 
    }

    function generatePrintHTML(q) {
        const itemsHtml = (q.items || []).map((i,idx)=>`<tr><td align="center">${idx+1}</td><td>${i.desc}</td><td>${i.spec||''}</td><td align="center">${i.w?i.w+'x'+i.h:'-'}</td><td align="center">${i.qty}</td><td align="center">${i.unit||'å¼'}</td><td align="right">${parseFloat(i.price).toLocaleString()}</td><td align="right">${parseFloat(i.amt).toLocaleString()}</td></tr>`).join('');
        const taxText = `ç‡Ÿæ¥­ç¨… (${(q.taxRate !== undefined ? q.taxRate : 5)}%)`;

        return `
            <div class="print-header">
                <div class="company-title">${COMPANY_INFO.title}</div>
                <div class="company-info">${COMPANY_INFO.details.replace(/\n/g, '<br>')}</div>
            </div>
            <div style="text-align:center; font-size:24px; font-weight:bold; margin:15px 0;">å ± åƒ¹ å–®</div>
            <div class="quote-info-grid">
                <div style="width:60%">
                    <div class="info-row"><span class="info-label">å®¢æˆ¶åç¨±ï¼š</span><span>${q.cust}</span></div>
                    <div class="info-row"><span class="info-label">è¯çµ¡äººï¼š</span><span>${q.contact || ''}</span></div>
                    <div class="info-row"><span class="info-label">é›»è©±ï¼š</span><span>${q.phone || ''}</span></div>
                    <div class="info-row"><span class="info-label">åœ°å€ï¼š</span><span>${q.address || ''}</span></div>
                    <div class="info-row"><span class="info-label">çµ±ç·¨ï¼š</span><span>${q.taxId || ''}</span></div>
                </div>
                <div style="width:35%; text-align:right;">
                    <div class="info-row" style="justify-content:flex-end;"><span class="info-label">å–®è™Ÿï¼š</span><span>#${q.id}</span></div>
                    <div class="info-row" style="justify-content:flex-end;"><span class="info-label">æ—¥æœŸï¼š</span><span>${q.date}</span></div>
                    <div class="info-row" style="justify-content:flex-end;"><span class="info-label">å°ˆæ¡ˆï¼š</span><span>${q.proj}</span></div>
                </div>
            </div>
            <table class="print-table">
                <thead><tr><th>#</th><th>é …ç›®</th><th>è¦æ ¼</th><th>å°ºå¯¸</th><th>é‡</th><th>å–®ä½</th><th>å–®åƒ¹</th><th>é‡‘é¡</th></tr></thead>
                <tbody>${itemsHtml}</tbody>
                <tfoot>
                    <tr><td colspan="7" align="right">åˆè¨ˆ (æœªç¨…)</td><td align="right">${(q.subtotal||0).toLocaleString()}</td></tr>
                    <tr><td colspan="7" align="right">${taxText}</td><td align="right">${(q.tax||0).toLocaleString()}</td></tr>
                    <tr><td colspan="7" align="right" style="font-weight:bold;">ç¸½è¨ˆ (å«ç¨…)</td><td align="right" style="font-weight:bold;">NT$ ${(q.total||0).toLocaleString()}</td></tr>
                </tfoot>
            </table>
            <div style="border:1px solid #000; padding:10px; font-size:12px; min-height:60px;"><strong>å‚™è¨»ï¼š</strong><br><pre style="font-family:inherit; white-space: pre-wrap; margin:0;">${q.note}</pre></div>
            
            <div class="signature-section">
                <div class="sign-box">
                    <div class="sign-title">å®¢æˆ¶ç°½ç« </div>
                    <div class="sign-placeholder">(ç°½åå›å‚³)</div>
                </div>
                <div class="sign-box" onclick="document.getElementById('stampLoader').click()">
                    <div class="sign-title">æ¥­å‹™ç°½ç« </div>
                    <img src="${stampData}" class="stamp-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="stamp-alt-text">âŒ é»æ“Šè¼‰å…¥å°ç« </div>
                </div>
            </div>
        `;
    }

    function previewQuote(id) {
        const q = db.quotes.find(x => x.id == id); if(!q) return;
        const m = document.getElementById('previewModal');
        m.innerHTML = generatePrintHTML(q) + `<div style="text-align:center;margin-top:10px;"><button class="btn btn-danger" onclick="closePreview()">é—œé–‰</button></div>`;
        m.style.display = 'block'; document.getElementById('previewOverlay').style.display = 'block';
    }
    function closePreview() { document.getElementById('previewModal').style.display = 'none'; document.getElementById('previewOverlay').style.display = 'none'; }

    async function printQuote(id, type) {
        const q = db.quotes.find(x => x.id == id);
        const div = document.getElementById('printArea');
        div.innerHTML = generatePrintHTML(q);
        if(type === 'pdf') window.print();
        else if(type === 'jpg') {
            div.style.display = 'block';
            try {
                const imgs = div.querySelectorAll('img');
                await Promise.all(Array.from(imgs).map(img => {
                    if (img.complete) return Promise.resolve();
                    return new Promise(resolve => { img.onload = resolve; img.onerror = resolve; });
                }));
                const canvas = await html2canvas(div, { scale: 2, useCORS: true, allowTaint: true });
                const link = document.createElement('a'); link.download = `å ±åƒ¹å–®_${q.cust}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9); link.click();
            } catch(e) { console.error(e); alert('åœ–ç‰‡ç”¢ç”Ÿå¤±æ•—'); } finally { div.style.display = 'none'; }
        }
    }
    
    function exportData() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(db)); a.download="ERP_Quote_Cloud_Backup.json"; a.click(); }

    async function importData(input) {
        const f = input.files[0];
        if(!f) return;
        
        const r = new FileReader();
        r.onload = async function(e) {
            try {
                let content = JSON.parse(e.target.result);
                if (content.quotes && !content.q) { content.q = content.quotes; delete content.quotes; }
                if(!confirm("âš ï¸ åš´é‡è­¦å‘Šï¼šå°‡è¦†è“‹é›²ç«¯è³‡æ–™ï¼ç¢ºå®šå—ï¼Ÿ")) return;
                
                await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'FULL_RESTORE', allData: content }) });
                alert('âœ… é‚„åŸæˆåŠŸï¼'); location.reload();
            } catch(err) { alert('âŒ å¤±æ•—'); }
        };
        r.readAsText(f);
        input.value = ''; 
    }

    function showPriceAnalysis(btn) {
        const wrapper = btn.parentElement;
        const input = wrapper.querySelector('input.i-desc');
        if (!input) return;
        const productName = input.value.trim();
        if(!productName) return alert("è«‹å…ˆè¼¸å…¥å“å");

        const oldCard = document.querySelector('.price-analysis-card'); if(oldCard) oldCard.remove();

        let dbMat = null;
        let suggestedPrice = null;
        let costPrice = null;
        if(db.materials) {
            dbMat = db.materials.find(m => m.name === productName);
            if(dbMat) {
                costPrice = dbMat.cost;
                suggestedPrice = dbMat.price > 0 ? dbMat.price : Math.round(dbMat.cost * 1.3);
            }
        }

        const card = document.createElement('div');
        card.className = 'price-analysis-card';
        let suggestHtml = '';
        if (suggestedPrice) {
            let profitRate = costPrice > 0 ? Math.round(((suggestedPrice - costPrice)/suggestedPrice)*100) : 0;
            suggestHtml = `
                <div style="background:#ecfdf5; padding:10px; border-bottom:1px solid #d1fae5;">
                    <div style="font-size:12px; color:#047857; font-weight:bold;">ğŸ’¡ AI å»ºè­°å”®åƒ¹</div>
                    <div style="font-size:20px; font-weight:900; color:#059669; display:flex; justify-content:space-between; align-items:end;">
                        $${suggestedPrice.toLocaleString()}
                        <span style="font-size:11px; color:#666;">é ä¼°æ¯›åˆ©: ${profitRate}%</span>
                    </div>
                    ${costPrice ? `<div style="font-size:10px; color:#666;">(æˆæœ¬: $${costPrice.toLocaleString()})</div>` : ''}
                </div>`;
        } else {
            suggestHtml = `<div style="padding:10px; background:#f9fafb; font-size:12px; color:#666;">â„¹ï¸ ç„¡æˆæœ¬è³‡æ–™ã€‚è«‹è‡³ã€Œææ–™åº«ã€å»ºç«‹ã€‚</div>`;
        }

        card.innerHTML = `
            <div style="background:#6366f1; color:white; padding:8px 12px; font-weight:bold; display:flex; justify-content:space-between;">
                <span>ğŸ§  åˆ†æï¼š${productName}</span>
                <span style="cursor:pointer;" onclick="this.parentElement.parentElement.remove()">âœ•</span>
            </div>
            ${suggestHtml}
        `;
        document.body.appendChild(card);
        const rect = input.getBoundingClientRect();
        const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        card.style.top = (rect.bottom + scrollTop + 5) + 'px';
        card.style.left = (rect.left + scrollLeft) + 'px';
        setTimeout(() => {
            const closer = function(e) { if(!card.contains(e.target) && e.target !== btn) { card.remove(); document.removeEventListener('click', closer); }};
            document.addEventListener('click', closer);
        }, 100);
    }

    function parseSpecSize(el) {
        const val = el.value.trim(); if(!val) return;
        const regex = /(\d+(?:\.\d+)?)\s*(mm|cm|m|in|inch|ft|å¯¸|å‹|å°º|å‘|å…¬åˆ†|å…¬é‡|å…¬å°º)?\s*[xX*]\s*(\d+(?:\.\d+)?)\s*(mm|cm|m|in|inch|ft|å¯¸|å‹|å°º|å‘|å…¬åˆ†|å…¬é‡|å…¬å°º)?/i;
        const match = val.match(regex);
        if (match) {
            let num1 = match[1], unit1 = match[2], num2 = match[3], unit2 = match[4];
            if (!unit1 && unit2) unit1 = unit2;
            const finalW = convertToCm(num1, unit1);
            const finalH = convertToCm(num2, unit2);
            const row = el.closest('.item-row');
            const wInput = row.querySelector('.i-w'), hInput = row.querySelector('.i-h');
            if (parseFloat(wInput.value) !== parseFloat(finalW.toFixed(1)) || parseFloat(hInput.value) !== parseFloat(finalH.toFixed(1))) {
                wInput.value = parseFloat(finalW.toFixed(1)); hInput.value = parseFloat(finalH.toFixed(1));
                wInput.style.backgroundColor = '#fef08a'; hInput.style.backgroundColor = '#fef08a';
                setTimeout(() => { wInput.style.backgroundColor = ''; hInput.style.backgroundColor = ''; }, 800);
                calcRow(wInput);
            }
        }
    }
    function convertToCm(value, unit) {
        if (!unit) return parseFloat(value);
        unit = unit.toLowerCase().trim(); const v = parseFloat(value);
        if (unit.match(/mm|å…¬é‡/)) return v / 10;
        if (unit.match(/cm|å…¬åˆ†/)) return v;
        if (unit.match(/m|å…¬å°º/)) return v * 100;
        if (unit.match(/in|inch|å¯¸|å‹/)) return v * 2.54;
        if (unit.match(/ft|feet|å°º|å‘/)) return v * 30.48;
        return v;
    }

    async function saveMaterial() {
        const id = document.getElementById('m_id').value;
        const name = document.getElementById('m_name').value.trim();
        const unit = document.getElementById('m_unit').value.trim();
        const price = parseFloat(document.getElementById('m_price').value) || 0;
        const cost = parseFloat(document.getElementById('m_cost').value) || 0;
        if(!name) return alert('è«‹è¼¸å…¥åç¨±');
        if(!db.materials) db.materials = [];
        const newMat = { id: id ? parseInt(id) : Date.now(), name, unit, price, cost };
        if(id) { const idx = db.materials.findIndex(m => m.id == id); if(idx !== -1) db.materials[idx] = newMat; } 
        else { db.materials.unshift(newMat); if(!db.products.includes(name)) db.products.push(name); }
        renderMatTable(); resetMatForm(); updateProdList(); 
        
        try {
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'save_materials', materials: db.materials }) });
            alert('âœ… å„²å­˜ä¸¦åŒæ­¥æˆåŠŸï¼');
        } catch(e) { alert('âš ï¸ æœ¬åœ°å·²å­˜ï¼Œä½†é›²ç«¯åŒæ­¥å¤±æ•—'); }
        saveToLocal();
    }
    
    function renderMatTable() {
        const key = document.getElementById('m_search').value.toLowerCase();
        const list = (db.materials || []).filter(m => m.name.toLowerCase().includes(key));
        document.getElementById('matListBody').innerHTML = list.map(m => {
            let profit = m.price - m.cost;
            let margin = m.price > 0 ? Math.round((profit / m.price) * 100) : 0;
            let marginClass = margin < 20 ? 'profit-low' : 'profit-high';
            return `<tr><td>${m.name}</td><td>${m.unit || '-'}</td><td>$${m.price}</td><td style="color:#64748b;">$${m.cost}</td><td class="${marginClass}">${margin}%</td><td><button class="btn btn-sm btn-primary" onclick="editMat(${m.id})">âœ</button><button class="btn btn-sm btn-danger" onclick="delMat(${m.id})">ğŸ—‘ï¸</button></td></tr>`;
        }).join('');
    }
    function openMatModal() { document.getElementById('matModal').style.display = 'flex'; renderMatTable(); }
    function closeMatModal() { document.getElementById('matModal').style.display = 'none'; resetMatForm(); }
    function resetMatForm() { document.getElementById('m_id').value = ''; document.getElementById('m_name').value = ''; document.getElementById('m_unit').value = ''; document.getElementById('m_price').value = ''; document.getElementById('m_cost').value = ''; document.getElementById('m_profit').value = ''; }
    function editMat(id) { const m = db.materials.find(x => x.id == id); if(!m) return; document.getElementById('m_id').value = m.id; document.getElementById('m_name').value = m.name; document.getElementById('m_unit').value = m.unit; document.getElementById('m_price').value = m.price; document.getElementById('m_cost').value = m.cost; }
    function delMat(id) { if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return; db.materials = db.materials.filter(m => m.id !== id); saveToLocal(); renderMatTable(); }
    
    function copyQuote(id) {
        const q = db.quotes.find(x => x.id == id); if(!q) return;
        document.getElementById('q_id').value = ''; document.getElementById('q_date').valueAsDate = new Date(); document.getElementById('q_valid').value = '';
        document.getElementById('q_proj').value = q.proj + " (è¤‡è£½)"; document.getElementById('q_cust').value = q.cust;
        currentQuoteContacts = []; if (q.contact) { const parts = q.contact.split('ã€'); parts.forEach(str => { const match = str.match(/^(.*?)\((.*?)\)$/); if (match) currentQuoteContacts.push({ n: match[1], p: match[2] }); else currentQuoteContacts.push({ n: str, p: '' }); }); } renderContactTags();
        document.getElementById('q_phone').value = q.phone || ''; document.getElementById('q_address').value = q.address || ''; document.getElementById('q_tax_id').value = q.taxId || ''; document.getElementById('q_note').value = q.note; document.getElementById('q_tax_rate').value = (q.taxRate !== undefined) ? q.taxRate : 5;
        document.getElementById('itemContainer').innerHTML = '';
        if(q.items) q.items.forEach(i => addItem(i.desc, i.spec, i.w, i.h, i.qty, i.price, i.unit, i.amt, i.cost));
        calcTotal(); document.querySelector('details').open = true; window.scrollTo(0,0);
        alert('ğŸ“‹ å·²è¤‡è£½ï¼');
    }
    
    async function delQuote(id) { 
        if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) return;
        db.quotes = db.quotes.filter(x => x.id != id); renderList(); 
        try { await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete_item', type: 'q', id: id }) }); saveToLocal(); } catch(e) {}
    }
    function sortList(field) { if (sortState.field === field) sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc'; else { sortState.field = field; sortState.dir = 'desc'; } renderList(); }
</script>
</body>
</html>